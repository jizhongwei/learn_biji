#### 1、知识点

- 数据库的概念
- MySQL 的安装

#### 2、运行环境

- Ubuntu Linux 16.04 64 位版本
- MySQL5.7.22
- Linux 终端

#### 3、数据库和 SQL 概念

> 数据库（database）是按照数据结构来组织、存储和管理数据的仓库，它的产生距今已有六十多年。随着信息技术和市场的发展，数据库变得无处不在；
> 数据库用于记录数据，使用数据库记录数据可以表现出各种数据间的联系，也可以很方便地对所记录的数据进行增删改查等操作；
> 结构化查询语言（structured query language)简称 SQL，是上世纪 70 年代由 IBM 公司开发，用于对数据库进行操作的语言。更详细地说，SQL 是一种数据库查询和程序设计语言，用于存取数据以及查询、更新和管理关系数据库系统，同时也是数据库脚本文件的扩展名。

#### 4、MySQL

> MySQL 是一个 DBMS（数据库管理系统），由瑞典 MySQLAB 公司开发，目前属于 Oracle 公司，MySQL 是最流行的关系型数据库管理系统（关系数据库，是建立在关系数据库模型基础上的数据库，借助于集合代数等概念和方法来处理数据库中的数据）。由于其体积小、速度快、总体拥有成本低，尤其是开放源代码这一特点，一般中小型网站的开发者都选择 MySQL 作为网站数据库。

#### 检查系统是否已经安装 MySQL

> 在命令行输入一下命令
> \$ sudo service mysql start
> 如果提示是这样，这说明系统中没有 MySQL
> mysql：unrecognized service

#### 在 Ubuntu 上安装 MySQL

只需幾行簡單的命令

```
#安装MySQL服务端、核心程序
sudo apt-get install mysql-server
#安装MySQL客户端
sudo apt-get install mysql-client

# 验证安装成功
sudo netstat -tap | grep mysql

# 查看MySQL配置文件my.cnf
sudo vim /etc/mysql/my.cnf
```

#### 尝试 MySQL

打开 MySQL

```
sudo service mysql start
#登录
mysql -u root -p
#查看数据库
show databases;
#使用数据库
use xxxx;
#查看数据表
show tables;
# 退出
quit/exit
# 创建数据库
create database 数据库名称;
```

> 数据库（table）简称表，它是数据库最重要的组成部分之一，数据库只是一个框架，表才是实质内容。
> 而一个数据库一般会有多张表，这些各自独立的表通过建立关系被联接起来，才成为可以交叉查阅、一目了然的数据库。

创建表

```
create table xxx(
    列名a 数据类型(数据长度),
    列名b 数据类型(数据长度),
    列名c 数据类型(数据长度),
);
```

数据类型

| 数据类型 | 大小（字节） | 用途             | 格式              |
| -------- | ------------ | ---------------- | ----------------- |
| int      | 4            | 整数             |                   |
| float    | 4            | 单精度浮点数     |                   |
| double   | 8            | 双精度浮点数     |                   |
| enum     | --           | 单选，比如性别   | enum('a','b','c') |
| set      | --           | 多选             | set('1','2','3')  |
| date     | 3            | 日期             | YYYY-MM-DD        |
| time     | 3            | 时间点或持续时间 | HH:MM:SS          |
| year     | 1            | 年份值           | YYYY              |
| char     | 0~255        | 定长字符串       |                   |
| varchar  | 0~255        | 变长字符串       |                   |
| text     | 0~65535      | 长文本数据       |                   |

整数除了 int 外，还有 tinyint、smallint、mediumint、bigint。

char 和 varchar 的区别：char 的长度是固定的，而 varchar 的长度是可以变化的，比如，存储字符串‘abc’，对于 char(10)，表示存储的字符串占 10 个字节（包括 7 个空字符），而同样的 varchar(12)则只占用 4 个字节的长度，增加一个额外字节来存储字符串本身的长度，12 只是最大值，当你存储的字符小于 12 时，按实际长度存储。

enum 和 set 的区别：enum 类型的数据的值，必须是定义时枚举的值的其中之一，即单选，而 set 类型的值则可以多选。

```
#查看表数据
select * from table_name;
#插入数据
insert into table_name(列名a,列名b,列名c) values (v1,v2,v3);
```

#### 约束

约束是一种限制，它通过对表的行或列的数据做出限制，来确保表的数据的完整性、唯一性等。 \*_比如，规定一个用户的用户名不能为空且没有重复的记录，这就是一种约束规则_

约束分类
|约束类型|主键|默认值|唯一|外键|非空|
|-|-|-|-|-|-|
|关键字|primary key|default|unique|foreign key|not null|

##### 主键

在数据库中，如果有两行记录数据完全一样，那么如何来区分呢？答案是无法区分，如果有两行记录完全相同，那么对于 MySQL 就会认定它们是同一个实体，这于现实生活是存在差别的。
假如我们要存储一个学生的信息，信息包含姓名、身高、性别、年龄。
不幸的是有两个女孩都叫小梦，且它们的身高和年龄相同，数据库将无法区分这两个实体，这时就需要用到主键了。

**_主键（primary key）是用于约束表中的一行，作为这一行的唯一标识符，在一张表中通过主键就能准确定位到一行，因此主键十分重要，主键不能有重复记录且不能为空_**

```
#主键定义方式
id int(10) primary key,
constraint pk_name primary key (要设为主键的字段名)
pk_name为自定义

复合主键：主键不仅可以是表中的一列，也可以由表中的两列或多列来共同标识，
constraint proj_pk primary key (proj_num, proj_name),
```

```
#删除数据库
drop database xxxx;
#从sql文件中生成数据库命令
source sql文件路径
```

#### 默认值约束

默认值约束（default）规定，当有 default 约束的列，插入数据为空时，将使用默认值。

默认值常用于一些可有可无的字段，比如用户的个性签名，如果用户没有设置，系统给它应该设定一个默认的文本，比如空文本或“这个人太懒了，没有留下任何信息”；

```
people_num int(10) default '10',
```

#### 唯一约束

唯一约束（unique）比较简单，它规定一张表中指定的一列的值必须不能重复值，即这一列每个值都是唯一的

```
unique (phone),
```

#### 外键约束

外键（foreign key）既能确保数据完整性，也能表现表之间的关系。

比如，现在有用户表和文章表，给文章表中添加一个指向用户 id 的外键，表示这篇文章所属的用户 id，外键将确保这个外键指向的记录是存在的，如果你尝试删除一个用户，而这个用户还有文章存在于数据库中，那么操作将无法完成并报错。因为你删除了该用户过后，他发布的文章都没有所属用户了，而这样的情况是不被允许的。同理，你在创建一篇文章的时候也不能为它指定一个不存在的用户 id。
一个表可以有多个外键，每个外键必须 references(参考)另一个表的主键，被外键约束的列，取值必须在它参考的列中有对应值。

```
constraint emp_fk foreign key(in_dpt) references department(dpt_name),
```

#### 非空约束

非空约束（not null），听名字就能理解，被非空约束的列，在插入值时必须非空。

#### 挑战-搭建一个简单的成绩管理系统数据库

```
create database gradesystem;
use gradesystem;
create table student(
    sid int not null auto_increment,
    sname varchar(20) not null,
    gender varchar(10) not null,
    primary key(sid)
);

create table course(
    cid int not null auto_increment,
    cname varchar(20) not null,
    primary key(cid)
);

create table mark(
    mid int not null auto_increment,
    sid int not null,
    cid int not null,
    score int not null,
    primary key(mid),
    foreign key(sid) references student(sid),
    foreign key(cid) references course(cid)
);
```

---

#### select 语句详解

SQL 中最常用的 select 语句，用来在表中选取数据

- select 基本语法
- 数学符号条件
- and or in
- 通配符
- 排序
- SQL 内置函数和计算
- 子查询与连接查询

```
select语句的基本格式
select 要查询的列名 from 表名字 where 限制条件；
```

### 通配符

关键字 like 可用于实现模糊查询，常见于搜索功能中
和 like 联用的通常还有通配符，代表未知字符。SQL 中的通配符是*和%，其中*代表一个未指定字符，%代表不定个未指定字符

#### SQL 内置函数和计算

| 函数名 | count | sum  | avg      | max    | min    |
| ------ | ----- | ---- | -------- | ------ | ------ |
| 作用   | 计数  | 求和 | 求平均值 | 最大值 | 最小值 |

> 其中 COUNT 函数可用于任何数据类型(因为它只是计数)，而 SUM 、AVG 函数都只能对数字类数据类型做计算，MAX 和 MIN 可用于数值、字符串或是日期时间数据类型。

having 关键字的作用和 where 是一样的，都是说明接下来要进行条件筛选操作，区别在于 having 用于分组后的数据筛选。

---

#### 数据库及表的修改和删除

- 数据库操作
- 数据表操作
- 更新和删除数据

###### 修改数据库名

> 事实上，数据库名几乎不会遇到必须修改的情况，如果你一定要这么做，比较安全的做法是重新建一个新库，然后将旧库中的数据转移到新库中，并且暂时不要删除旧的数据库，以防数据遗失。

重命名一张表

```
rename table 原名 to 新名字;
alter table old rename new;
alter table old rename to new;
```

删除一张表

```
DROP TABLE 表名字;
```

#### 修改表结构

对表结构的修改，是本节实验的难点，有时候一些小的错误会造成不可挽回的后果，所以请细心操作。另外需要注意，非必要情况不要修改表结构。

1、增加一列

```
ALTER TABLE 表名字 ADD COLUMN 列名字 数据类型 约束;
或：
ALTER TABLE 表名字 ADD 列名字 数据类型 约束;
```

> 新增加的列，被默认放置在这张表的最右边。如果要把增加的列插入在指定位置，则需要在语句的最后使用 AFTER 关键词(“AFTER 列 1” 表示新增的列被放置在 “列 1” 的后面)。
> 如果想放在第一列的位置，则使用 FIRST 关键词

2、删除一列

删除表中的一列和刚才使用的新增一列的语句格式十分相似，只是把关键词 ADD 改为 DROP ，语句后面不需要有数据类型、约束或位置信息。具体语句格式：

```
ALTER TABLE 表名字 DROP COLUMN 列名字;

或： ALTER TABLE 表名字 DROP 列名字;
```

3、重命名一列

这条语句其实不只可用于重命名一列，准确地说，它是对一个列做修改(CHANGE) ：

```
ALTER TABLE 表名字 CHANGE 原列名 新列名 数据类型 约束;
```

> 注意：这条重命名语句后面的 “数据类型” 不能省略，否则重命名失败。

> 当原列名和新列名相同的时候，指定新的数据类型或约束，就可以用于修改数据类型或约束。需要注意的是，修改数据类型可能会导致数据丢失，所以要慎重使用。

4、改变数据类型

要修改一列的数据类型，除了使用刚才的 CHANGE 语句外，还可以用这样的 MODIFY 语句：

```
ALTER TABLE 表名字 MODIFY 列名字 新数据类型;
```

> 再次提醒，修改数据类型必须小心，因为这可能会导致数据丢失。在尝试修改数据类型之前，请慎重考虑。

#### 修改表的内容

1、修改表中的某个值
大多数时候我们需要做修改的不会是整个数据库或整张表，而是表中的某一个或几个数据，这就需要我们用下面这条命令达到精确的修改：

```
UPDATE 表名字 SET 列1=值1,列2=值2 WHERE 条件;
```

> 注意：一定要有 WHERE 条件，否则会出现你不想看到的后果

2、删除一行记录

删除表中的一行数据，也必须加上 WHERE 条件，否则整列的数据都会被删除。

```
DELETE FROM 表名字 WHERE 条件;
```

---

#### 其他操作

- 索引
- 视图
- 导入和导出
- 备份和恢复

1、索引

> 索引是一种与表有关的结构，它的作用相当于书的目录，可以根据目录中的页码快速找到所需的内容。

> 当表中有大量记录时，若要对表进行查询，没有索引的情况是全表搜索：将所有记录一一取出，和查询条件进行对比，然后返回满足条件的记录。这样做会执行大量磁盘 I/O 操作，并花费大量数据库系统时间。

> 而如果在表中已建立索引，在索引中找到符合查询条件的索引值，通过索引值就可以快速找到表中的数据，可以大大加快查询速度。

对一张表中的某个列建立索引，有以下两种语句格式：

```
ALTER TABLE 表名字 ADD INDEX 索引名 (列名);

CREATE INDEX 索引名 ON 表名字 (列名);
```

> 索引的效果是加快查询速度，当表中数据不够多的时候是感受不出它的效果的。

这里我们使用命令

```
SHOW INDEX FROM 表名字;
```

在使用 SELECT 语句查询的时候，语句中 WHERE 里面的条件，会自动判断有没有可用的索引。

比如有一个用户表，它拥有用户名(username)和个人签名(note)两个字段。其中用户名具有唯一性，并且格式具有较强的限制，我们给用户名加上一个唯一索引；个性签名格式多变，而且允许不同用户使用重复的签名，不加任何索引。

这时候，如果你要查找某一用户，使用语句 select _ from user where username=? 和 select _ from user where note=? 性能是有很大差距的，对建立了索引的用户名进行条件查询会比没有索引的个性签名条件查询快几倍，在数据量大的时候，这个差距只会更大。

一些字段不适合创建索引，比如性别，这个字段存在大量的重复记录无法享受索引带来的速度加成，甚至会拖累数据库，导致数据冗余和额外的 CPU 开销。

2、视图

视图是从一个或多个表中导出来的表，是一种虚拟存在的表。它就像一个窗口，通过这个窗口可以看到系统专门提供的数据，这样，用户可以不用看到整个数据库中的数据，而只关心对自己有用的数据。

注意理解视图是虚拟的表：

- 数据库中只存放了视图的定义，而没有存放视图中的数据，这些数据存放在原来的表中；
- 使用视图查询数据时，数据库系统会从原来的表中取出对应的数据；
- 视图中的数据依赖于原来表中的数据，一旦表中数据发生改变，显示在视图中的数据也会发生改变；
- 在使用视图的时候，可以把它当作一张表。

创建视图的语句格式为：

```
CREATE VIEW 视图名(列a,列b,列c) AS SELECT 列1,列2,列3 FROM 表名字;
```

> 可见创建视图的语句，后半句是一个 SELECT 查询语句，所以视图也可以建立在多张表上，只需在 SELECT 语句中使用子查询或连接查询，这些在之前的实验已经进行过。

3、导入

> 此处讲解的是导入一个纯数据文件，该文件中将包含与数据表字段相对应的多条数据，这样可以快速导入大量数据，除此之外，还有用 SQL 语句的导入方式，语法为：source \*.sql 这是实验中经常用到的。**两者之间的不同是：数据文件导入方式只包含数据，导入规则由数据库系统完成；SQL 文件导入相当于执行该文件中包含的 SQL 语句，可以实现多种操作，包括删除，更新，新增，甚至对数据库的重建**。

数据文件导入，可以把一个文件里的数据保存进一张表。导入语句格式为：

```
LOAD DATA INFILE '文件路径和文件名' INTO TABLE 表名字;
```

由于导入导出大量数据都属于敏感操作，根据 mysql 的安全策略，导入导出的文件都必须在指定的路径下进行，在 mysql 终端中查看路径变量：

```
命令：
show variables like '%secure%';
输出结果：
+--------------------------+-----------------------+
| Variable_name            | Value                 |
+--------------------------+-----------------------+
| require_secure_transport | OFF                   |
| secure_auth              | ON                    |
| secure_file_priv         | /var/lib/mysql-files/ |
+--------------------------+-----------------------+
```

> 注意到 secure_file_priv 变量指定安全路径为 /var/lib/mysql-files/ ，要导入数据文件，需要将该文件移动到安全路径下。

4、导出
导出与导入是相反的过程，是把数据库某个表中的数据保存到一个文件之中。导出语句基本格式为：

```
SELECT 列 1，列 2 INTO OUTFILE '文件路径和文件名' FROM 表名字;
```

> 注意：语句中 “文件路径” 之下不能已经有同名文件。

5、备份

数据库中的数据十分重要，出于安全性考虑，在数据库的使用中，应该注意使用备份功能。

> 备份与导出的区别：导出的文件只是保存数据库中的数据；而备份，则是把数据库的结构，包括数据、约束、索引、视图等全部另存为一个文件。

mysqldump 是 MySQL 用于备份数据库的实用程序。它主要产生一个 SQL 脚本文件，其中包含从头重新创建数据库所必需的命令 CREATE TABLE INSERT 等。

使用 mysqldump 备份的语句：

```
#备份整个数据库
mysqldump -u root 数据库名>备份文件名;

#备份整个表
mysqldump -u root 数据库名 表名字>备份文件名;
```

mysqldump 是一个备份工具，因此该命令是在终端中执行的，而不是在 mysql 交互环境下

6、恢复数据

```
方式一：
mysql> source path_to/*.sql;
方式二：
mysql -u root
create database db_name;
mysql -u root db_name < xxx.sql
```

7、总结
1、索引：可以加快查询速度
2、视图：是一种虚拟存在的表
3、导入：从文件中导入数据到表
4、导出：从表中导出到文件中
5、备份：mysqldump备份数据库到文件
6、恢复：从文件恢复数据库